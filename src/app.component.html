<div class="font-sans">
  @if (!loggedInUser()) {
    <!-- Login Screen -->
    <div class="min-h-screen flex flex-col items-center justify-center bg-slate-100 p-4">
      <h1 class="text-3xl font-bold text-slate-700 mb-2">家事</h1>
      <p class="text-slate-500 mb-8">请使用您的账户登录</p>
      
      <form [formGroup]="loginForm" (ngSubmit)="onLoginSubmit()" class="w-full max-w-sm space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-slate-700">用户名</label>
          <input id="username" type="text" formControlName="username" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-slate-700">密码</label>
          <input id="password" type="password" formControlName="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
        </div>
        
        @if (loginError()) {
          <p class="text-sm text-red-600">{{ loginError() }}</p>
        }

        <button type="submit" [disabled]="loginForm.invalid || isLoggingIn()" class="w-full flex justify-center items-center gap-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:bg-slate-400 disabled:cursor-not-allowed">
          @if(isLoggingIn()) {
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>登录中...</span>
          } @else {
            <span>登录</span>
          }
        </button>
      </form>

      <div class="mt-6 text-xs text-slate-500 text-center p-3 bg-slate-200/80 rounded-lg w-full max-w-sm">
        <p class="font-bold">测试账户:</p>
        <p>用户名: me, mom, dad, alex</p>
        <p>密码: password123</p>
      </div>
    </div>
  } @else {
    <!-- Main App Content -->
    <!-- Scrollable Content Area -->
    <div class="max-w-2xl mx-auto p-4 sm:p-6 lg:p-8 pb-24">
      @if (activeTab() === 'home') {
        <!-- Sticky Header Wrapper -->
        <div class="sticky top-0 z-10 bg-slate-50/90 backdrop-blur-sm">
          <!-- Sticky Home Screen Tabs -->
          <nav #mainNav class="-mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-2 border-b border-slate-200">
            <div class="flex items-center justify-between">
              <div class="bg-slate-200/80 p-1 rounded-lg flex flex-wrap gap-1 text-xs font-bold">
                <button (click)="setActiveHomeTab('all')" [class]="activeHomeTab() === 'all' ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'" class="py-1.5 px-2 rounded-md transition-all">
                  全部
                </button>
                <button (click)="setActiveHomeTab('daily')" [class]="activeHomeTab() === 'daily' ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'" class="py-1.5 px-2 rounded-md transition-all">
                  家庭日常
                </button>
                <button (click)="setActiveHomeTab('health')" [class]="activeHomeTab() === 'health' ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'" class="py-1.5 px-2 rounded-md transition-all">
                  家庭健康
                </button>
                <button (click)="setActiveHomeTab('knowledge')" [class]="activeHomeTab() === 'knowledge' ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'" class="py-1.5 px-2 rounded-md transition-all">
                  知识分享
                </button>
              </div>
               <button (click)="logout()" class="p-2 rounded-full hover:bg-slate-200 transition-colors" aria-label="切换用户">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-slate-600">
                    <path fill-rule="evenodd" d="M2 3.25A1.25 1.25 0 0 1 3.25 2h6.5A1.25 1.25 0 0 1 11 3.25v.5a.75.75 0 0 1-1.5 0v-.5a.25.25 0 0 0-.25-.25h-5.5a.25.25 0 0 0-.25.25v13.5c0 .138.112.25.25.25h5.5a.25.25 0 0 0 .25-.25v-.5a.75.75 0 0 1 1.5 0v.5A1.25 1.25 0 0 1 9.75 18h-6.5A1.25 1.25 0 0 1 2 16.75V3.25Z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M13.44 10.78a.75.75 0 0 0 0-1.56l-3.25-1.5a.75.75 0 0 0-.94 1.28L10.44 10l-1.19 1.53a.75.75 0 0 0 .94 1.28l3.25-1.5Z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M16.25 10a.75.75 0 0 0-.75-.75h-5.5a.75.75 0 0 0 0 1.5h5.5a.75.75 0 0 0 .75-.75Z" clip-rule="evenodd" />
                  </svg>
                </button>
            </div>
          </nav>

          <!-- Sticky Health Notice -->
          @if (urgentHealthPosts().length > 0) {
            <div #stickyNotice class="shadow-md animate-fade-in-down -mx-4 sm:-mx-6 lg:-mx-8 border-b border-slate-200">
                @for(post of urgentHealthPosts(); track post.id) {
                    @let typeConfig = getPostTypeConfig(post);
                    <div (click)="scrollToPost(post.id)" [class]="'px-4 sm:px-6 lg:px-8 py-2 flex items-center gap-3 text-sm border-b cursor-pointer hover:bg-red-100/50 transition-colors ' + typeConfig.colorClasses" [class.border-red-300]="true">
                        <span [class]="typeConfig.iconClasses + ' text-lg'">{{ typeConfig.icon }}</span>
                        @if (post.subject) {
                            <img [ngSrc]="post.subject.avatar" [alt]="post.subject.name" width="24" height="24" class="w-6 h-6 rounded-full object-cover">
                        }
                        <p class="font-semibold truncate flex-1">
                          {{ typeConfig.title }}: 
                          <span class="font-normal">{{ post.content }}</span>
                        </p>
                        <span class="text-xs font-medium text-red-700/80">{{post.timestamp}}</span>
                    </div>
                }
            </div>
          }
        </div>

        <main class="mt-6 space-y-6">
          @if (homePosts().length > 0) {
            @for (post of homePosts(); track post.id) {
              @let typeConfig = getPostTypeConfig(post);
              @let isMyPost = post.author === loggedInUser()!.name;
              @let isUrgent = urgentHealthPostIds().has(post.id);

              <div class="flex flex-col transition-opacity" [id]="'post-' + post.id" [class.opacity-50]="post.status === 'DONE'">
                <!-- Message Row -->
                <div class="flex items-start gap-3" [class.justify-end]="isMyPost">
                  
                  <!-- Avatar (DOM order: 1st) -->
                  <div [class.order-2]="isMyPost">
                    @if ($first) {
                      <img priority [ngSrc]="post.authorAvatar" [alt]="post.author + ' 头像'" width="40" height="40" class="h-10 w-10 rounded-full object-cover flex-shrink-0">
                    } @else {
                      <img [ngSrc]="post.authorAvatar" [alt]="post.author + ' 头像'" width="40" height="40" class="h-10 w-10 rounded-full object-cover flex-shrink-0">
                    }
                  </div>
            
                  <!-- Message Bubble (DOM order: 2nd) -->
                  <div class="w-full max-w-md flex flex-col" [class.order-1]="isMyPost" [class.items-end]="isMyPost" [class.items-start]="!isMyPost">
                    <div [class]="'p-4 w-full rounded-xl ' + typeConfig.bubbleClasses + (isMyPost ? ' rounded-tr-none' : ' rounded-tl-none')"
                         [class.shadow-lg]="isUrgent"
                         [class.ring-2]="isUrgent"
                         [class.ring-rose-500/50]="isUrgent"
                         [class.shadow-sm]="!isUrgent">
                      <!-- Bubble Header (Icon, Title, Priority, etc.) -->
                      <div class="flex justify-between items-start gap-4">
                        <h3 [class]="'font-bold text-base flex items-center gap-2 ' + typeConfig.headerTextClasses">
                          <span [class]="typeConfig.iconClasses">{{ typeConfig.icon }}</span>
                          <span>{{ typeConfig.title }}</span>
                        </h3>
                        <div class="flex items-center gap-2 shrink-0">
                          @if (post.dueDate) {
                            @let countdown = getCountdown(post.dueDate);
                            @if (countdown) {
                              <div [class]="'flex items-center gap-1.5 font-semibold text-sm ' + typeConfig.countdownClasses">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 animate-pulse">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" />
                                </svg>
                                <span>{{ countdown }}</span>
                              </div>
                            }
                          }
                          @if (post.priority) {
                            <span [class]="'text-xs font-semibold px-3 py-1 rounded-full ' + typeConfig.priorityChipClasses(post.priority)">
                              {{ getPriorityConfig(post.priority).text }}
                            </span>
                          }
                        </div>
                      </div>
                      <!-- Bubble Content -->
                      <p [class]="'mt-2 leading-relaxed ' + typeConfig.bodyTextClasses">{{ post.content }}</p>

                      <!-- AI Analysis Section -->
                      <div [class]="'mt-4 pt-3 border-t ' + typeConfig.separatorBorderClasses">
                        @if (post.isLoadingAiSuggestion) {
                            <div [class]="'flex items-center justify-center gap-2 text-sm p-2 ' + typeConfig.bodyTextClasses">
                              <svg class="animate-spin h-5 w-5 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                              </svg>
                              <span>AI 正在分析中...</span>
                            </div>
                        } @else if (post.aiSuggestions && post.aiSuggestions.length > 0) {
                          @let activeSuggestion = post.aiSuggestions[post.activeAiSuggestionIndex ?? 0];
                          <div [class]="'prose prose-sm max-w-none ' + typeConfig.bodyTextClasses" [class.prose-invert]="isDarkCard(post.type)" [innerHTML]="activeSuggestion.content">
                          </div>
                          <!-- Controls -->
                          <div class="mt-4 flex justify-between items-center gap-4">
                              <!-- Navigation -->
                              @if (post.aiSuggestions.length > 1) {
                                <div class="flex items-center gap-3 text-sm font-semibold" [class.text-white]="isDarkCard(post.type)" [class.text-slate-600]="!isDarkCard(post.type)">
                                  <button (click)="changeSuggestion(post, 'prev')" [class]="'p-1 rounded-full transition-colors ' + typeConfig.reactionButtonClasses" aria-label="上一条建议">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                      <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 0 1 0 1.06L9.06 10l3.73 3.71a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                                    </svg>
                                  </button>
                                  <span class="text-xs w-16 text-center">建议 {{ (post.activeAiSuggestionIndex ?? 0) + 1 }} / {{ post.aiSuggestions.length }}</span>
                                  <button (click)="changeSuggestion(post, 'next')" [class]="'p-1 rounded-full transition-colors ' + typeConfig.reactionButtonClasses" aria-label="下一条建议">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                      <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 0-1.06L10.94 10 7.21 6.29a.75.75 0 1 1 1.06-1.06l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                                    </svg>
                                  </button>
                                </div>
                              } @else {
                                <!-- Spacer to keep regenerate button on the right -->
                                <div></div>
                              }
                            
                              <!-- Regenerate Button -->
                              <button (click)="getAiAnalysisForPost(post)" [class]="'flex items-center gap-1.5 text-xs font-semibold px-3 py-1.5 rounded-full transition-colors ' + typeConfig.reactionButtonClasses">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                  <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201-4.42 5.5 5.5 0 0 1 10.842 2.162.75.75 0 0 1-1.49-.174.25.25 0 0 0-.493-.062c-.22.65-.54 1.253-.942 1.795a.75.75 0 0 1-1.054.093Z" clip-rule="evenodd" />
                                  <path fill-rule="evenodd" d="M4.688 8.576a5.5 5.5 0 0 1 9.201 4.42 5.5 5.5 0 0 1-10.842-2.162.75.75 0 0 1 1.49.174.25.25 0 0 0 .493.062c.22-.65.54-1.253.942-1.795a.75.75 0 0 1 1.054-.093ZM10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z" clip-rule="evenodd" />
                                </svg>
                                <span>重新生成</span>
                              </button>
                          </div>

                        } @else